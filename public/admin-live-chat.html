<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HippoClouds - Live Chat Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .admin-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; height: 80vh; }
        .sessions-sidebar { background: #f8f9fa; border-right: 1px solid #e9ecef; padding: 20px; overflow-y: auto; }
        .session-item { background: white; padding: 15px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px; }
        .session-item:hover { border-color: #3498db; }
        .session-item.active { border-color: #2ecc71; background: #f0fff4; }
        .chat-area { display: flex; flex-direction: column; height: 100%; }
        .chat-header { background: #34495e; color: white; padding: 15px 20px; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { max-width: 70%; margin-bottom: 15px; padding: 12px 16px; border-radius: 18px; }
        .user-message { background: #e3f2fd; margin-left: auto; }
        .admin-message { background: #dcf8c6; margin-right: auto; }
        .message-sender { font-weight: bold; font-size: 12px; margin-bottom: 4px; color: #555; }
        .message-time { font-size: 10px; color: #888; text-align: right; margin-top: 5px; }
        .chat-input-area { padding: 20px; border-top: 1px solid #e9ecef; background: white; }
        .input-group { display: flex; gap: 10px; }
        #messageInput { flex: 1; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 25px; outline: none; }
        #sendButton { background: #2ecc71; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; }
        .no-session { display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d; }
        .session-info { background: #e74c3c; color: white; padding: 10px; margin-bottom: 15px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>ðŸ¦› HippoClouds Live Chat Admin</h1>
            <p>Real-time customer support dashboard</p>
        </div>
        <div class="main-content">
            <div class="sessions-sidebar">
                <div class="session-info" id="sessionInfo">
                    Active Session Loaded! You can start chatting.
                </div>
                <h3>Current Session</h3>
                <div id="currentSessionInfo">
                    <p><strong>User:</strong> <span id="sessionUserName">Loading...</span></p>
                    <p><strong>Email:</strong> <span id="sessionUserEmail">Loading...</span></p>
                    <p><strong>Session ID:</strong> <span id="sessionIdDisplay">Loading...</span></p>
                    <p><strong>Started:</strong> <span id="sessionStartTime">Loading...</span></p>
                </div>
            </div>
            <div class="chat-area">
                <div class="chat-header">
                    <h3>Live Chat - <span id="headerUserName">User</span></h3>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="no-session">Loading messages...</div>
                </div>
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="Type your response..." maxlength="500">
                        <button id="sendButton">Send as Admin</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LiveChatAdmin {
            constructor() {
                this.currentSessionId = null;
                this.pollInterval = null;
                this.workerUrl = 'https://hippoclouds2025.saikumarbali555.workers.dev';
                
                this.initializeEventListeners();
                this.loadSessionFromURL();
            }
            
            initializeEventListeners() {
                document.getElementById('sendButton').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            loadSessionFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session');
                
                if (sessionId) {
                    this.currentSessionId = sessionId;
                    document.getElementById('sessionIdDisplay').textContent = sessionId;
                    this.startMessagePolling();
                } else {
                    document.getElementById('chatMessages').innerHTML = '<div class="no-session">No session specified in URL</div>';
                    document.getElementById('chat-input-area').style.display = 'none';
                }
            }
            
            async loadMessages() {
                if (!this.currentSessionId) return;
                
                try {
                    const response = await fetch(`${this.workerUrl}/live-chat/messages?sessionId=${this.currentSessionId}`);
                    const data = await response.json();
                    
                    if (data.messages) {
                        this.displayMessages(data.messages);
                    }
                    
                    if (data.userInfo) {
                        this.updateUserInfo(data.userInfo);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                    document.getElementById('chatMessages').innerHTML = '<div class="no-session">Error loading messages</div>';
                }
            }
            
            updateUserInfo(userInfo) {
                document.getElementById('sessionUserName').textContent = userInfo.userName || 'Unknown';
                document.getElementById('sessionUserEmail').textContent = userInfo.email || 'Not provided';
                document.getElementById('sessionStartTime').textContent = new Date(userInfo.startedAt).toLocaleString();
                document.getElementById('headerUserName').textContent = userInfo.userName || 'User';
            }
            
            displayMessages(messages) {
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div class="no-session">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => `
                    <div class="message ${msg.sender === 'admin' ? 'admin-message' : 'user-message'}">
                        <div class="message-sender">${msg.sender === 'admin' ? 'You (Admin)' : 'User'}</div>
                        <div class="message-content">${this.escapeHtml(msg.message)}</div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            async sendMessage() {
                if (!this.currentSessionId) return;
                
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) return;
                
                try {
                    const response = await fetch(`${this.workerUrl}/live-chat/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: this.currentSessionId,
                            message: message,
                            sender: 'admin'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        messageInput.value = '';
                        await this.loadMessages();
                    } else {
                        alert('Failed to send message: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                }
            }
            
            startMessagePolling() {
                this.pollInterval = setInterval(() => {
                    this.loadMessages();
                }, 2000);
                
                // Load immediately
                this.loadMessages();
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }
        
        // Initialize the admin chat
        const admin = new LiveChatAdmin();
    </script>
</body>
</html>