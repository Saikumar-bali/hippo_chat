<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HippoClouds - Live Chat Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .admin-container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; height: 80vh; }
        .sessions-sidebar { background: #f8f9fa; border-right: 1px solid #e9ecef; padding: 20px; overflow-y: auto; }
        .session-item { background: white; padding: 15px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px; }
        .session-item:hover { border-color: #3498db; }
        .session-item.active { border-color: #2ecc71; background: #f0fff4; }
        .chat-area { display: flex; flex-direction: column; height: 100%; }
        .chat-header { background: #34495e; color: white; padding: 15px 20px; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #fafafa; }
        .message { max-width: 70%; margin-bottom: 15px; padding: 12px 16px; border-radius: 18px; }
        .user-message { background: #e3f2fd; margin-left: auto; }
        .admin-message { background: #dcf8c6; margin-right: auto; }
        .chat-input-area { padding: 20px; border-top: 1px solid #e9ecef; background: white; }
        .input-group { display: flex; gap: 10px; }
        #messageInput { flex: 1; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 25px; outline: none; }
        #sendButton { background: #2ecc71; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; }
        .no-session { display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>ðŸ¦› HippoClouds Live Chat Admin</h1>
            <p>Real-time customer support dashboard</p>
        </div>
        <div class="main-content">
            <div class="sessions-sidebar">
                <h3>Manual Session Access</h3>
                <div class="session-item" onclick="admin.selectSession('session_1762748866828_7tj6ail22')">
                    <strong>John Doe</strong><br>
                    john@example.com<br>
                    <small>Session: session_1762748866828_7tj6ail22</small>
                </div>
                <div style="margin:20px 0; padding:10px; background:#f0f0f0; border-radius:5px;">
                    <h4>Test New Session:</h4>
                    <input type="text" id="newSessionId" placeholder="Paste session ID here" style="width:100%; padding:8px; margin:5px 0;">
                    <button onclick="admin.selectManualSession()" style="width:100%; padding:8px; background:#3498db; color:white; border:none; border-radius:5px;">Open Session</button>
                </div>
            </div>
            <div class="chat-area">
                <div class="chat-header" id="chatHeader">
                    <div class="no-session" id="noSession">Select a session to start chatting</div>
                    <div id="activeSessionInfo" style="display: none;">
                        <h3 id="sessionUserName">User Name</h3>
                        <p id="sessionUserEmail">Session: <span id="sessionIdDisplay"></span></p>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area" id="chatInputArea" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="messageInput" placeholder="Type your response..." maxlength="500">
                        <button id="sendButton">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LiveChatAdmin {
            constructor() {
                this.currentSessionId = null;
                this.pollInterval = null;
                this.workerUrl = 'https://hippoclouds2025.saikumarbali555.workers.dev';
                
                this.initializeEventListeners();
                
                // Check URL for session parameter
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session');
                if (sessionId) {
                    this.selectSession(sessionId);
                }
            }
            
            initializeEventListeners() {
                document.getElementById('sendButton').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            selectManualSession() {
                const sessionId = document.getElementById('newSessionId').value.trim();
                if (sessionId) {
                    this.selectSession(sessionId);
                }
            }
            
            async selectSession(sessionId) {
                this.currentSessionId = sessionId;
                
                // Highlight selected session
                document.querySelectorAll('.session-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                document.getElementById('noSession').style.display = 'none';
                document.getElementById('activeSessionInfo').style.display = 'block';
                document.getElementById('chatInputArea').style.display = 'block';
                
                document.getElementById('sessionIdDisplay').textContent = sessionId;
                document.getElementById('sessionUserName').textContent = 'User';
                
                await this.loadMessages();
                this.startMessagePolling();
            }
            
            async loadMessages() {
                if (!this.currentSessionId) return;
                
                try {
                    const response = await fetch(`${this.workerUrl}/live-chat/messages?sessionId=${this.currentSessionId}`);
                    const data = await response.json();
                    
                    if (data.messages) {
                        this.displayMessages(data.messages);
                    }
                    
                    // Update user info if available
                    if (data.userInfo) {
                        document.getElementById('sessionUserName').textContent = data.userInfo.userName || 'User';
                        document.getElementById('sessionUserEmail').textContent = 
                            `${data.userInfo.email} â€¢ Started: ${new Date(data.userInfo.startedAt).toLocaleString()}`;
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            displayMessages(messages) {
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = '<div class="no-session">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => `
                    <div class="message ${msg.sender === 'admin' ? 'admin-message' : 'user-message'}">
                        <div class="message-content">${this.escapeHtml(msg.message)}</div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()} - ${msg.sender}</div>
                    </div>
                `).join('');
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            async sendMessage() {
                if (!this.currentSessionId) return;
                
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (!message) return;
                
                try {
                    const response = await fetch(`${this.workerUrl}/live-chat/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: this.currentSessionId,
                            message: message,
                            sender: 'admin'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        messageInput.value = '';
                        await this.loadMessages();
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message');
                }
            }
            
            startMessagePolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                }
                
                this.pollInterval = setInterval(() => {
                    this.loadMessages();
                }, 2000);
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }
        
        const admin = new LiveChatAdmin();
    </script>
</body>
</html>